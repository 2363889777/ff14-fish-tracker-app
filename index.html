<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="A big fish tracker for FF14 that uses rarity to sort" />
    <meta name="author" content="Carbuncle Plushy (Balmung)" />

    <title>FFX|V Fish Tracker App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.css">

    <!-- <script data-main="js/app" src="https://cdn.jsdelivr.net/requirejs/2.1.22/require.js"></script> -->
    <script src="https://cdn.jsdelivr.net/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/underscorejs/1.8.3/underscore-min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/dot.js/1.1.1/doT.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.18.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/twix.js/1.1.5/twix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/rxjs/4.1.0/rx.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/rxjs/4.1.0/rx.lite.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/knockout/3.4.2/knockout.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-debug.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.js"></script> -->
    <!--<script src="https://cdn.jsdelivr.net/g/semantic-ui@2.2.10,jquery@3.2.1,twix.js@1.1.5,momentjs@2.18.1,dot.js@1.1.1"></script>-->

    <style type="text/css">
      .main.container {
        padding-top: 3em;
      }
      .weather-icon {
        width: 20px;
        height: 20px;
      }
      img {
        vertical-align: middle;
      }
    </style>
    <!-- <script type="text/javascript">
      ko.doTEngine = function () { }
      ko.doTEngine.prototype = ko.utils.extend(new ko.templateEngine(), {
        renderTemplateSource: function (templateSource, bindingContext, options) {
          var precompiled = templateSource.data('precompiled');
          if (!precompiled) {
            precompiled = doT.template("{{ with(it) { with(it.$data) { }}" + templateSource.text() + "{{ } } }}");
            templateSource.data('precompiled', precompiled);
          }

          var renderedMarkup = precompiled(bindingContext);
          return ko.utils.parseHtmlFragment(renderedMarkup);
        },
        createJavaScriptEvaluatorBlock: function(script) {
          return "{{= " + script + "}}";
        }
      });
      ko.setTemplateEngine(new ko.doTEngine());
    </script> -->

    <script src="js/app/time.js"></script>
    <script src="js/app/weather.js"></script>
    <script src="js/app/fish.js"></script>
    <script src="js/app/fishwatcher.js"></script>
    <script type="text/javascript">
      function shouldLog(a, b) {
        // fishes = _([a,b]).map((x) => x.name());
        // return _(fishes).contains("Ghost Carp");
        return false;
      }
      function compare(a, b) {
        return a < b ? -1 : b < a ? 1 : 0;
      }

      var maxTime = 0x7FFFFFFFFFFF;
      function getWindowStart(windows, offset) {
        if (windows === undefined) { return moment(maxTime); }
        if (windows.length <= offset) { return moment(maxTime); }
        return windows[offset].start();
      }
      function getWindowEnd(windows, offset) {
        if (windows === undefined) { return moment(maxTime); }
        if (windows.length <= offset) { return moment(maxTime); }
        return windows[offset].end();
      }

      function compareWindows(aStart, bStart, baseTime) {
        if (moment(aStart).isBefore(baseTime)) {
          aStart = moment(baseTime);
        }
        if (moment(bStart).isBefore(baseTime)) {
          bStart = moment(baseTime);
        }
        if (moment(aStart).isBefore(bStart)) {
          return -1;
        } else if (moment(aStart).isAfter(bStart)) {
          return 1;
        } else {
          return 0;
        }
      }

      function sortByNextAvailable(a, b, baseTime) {
        return compareWindows(getWindowStart(a.catchableRanges.peek(), 0),
                              getWindowStart(b.catchableRanges.peek(), 0),
                              baseTime);
      }

      function sortByWindowPeriods(a, b, baseTime) {
        var result = 0;
        // Fish which are ALWAYS up should come AFTER fish with limited uptime.
        var limitedA = a.alwaysAvailable() ? 1 : -1;
        var limitedB = b.alwaysAvailable() ? 1 : -1;
        result = compare(limitedA, limitedB);
        if (shouldLog(a, b))
          console.log("Comparing all-day availability:", result,
            "\n", a.name, a.alwaysAvailable(),
            "\n", b.name, b.alwaysAvailable());
        if (result != 0) {
          return result;
        }

        var aRanges = a.catchableRanges.peek();
        var bRanges = b.catchableRanges.peek();

        // Next, we must consider fish which are CURRENTLY available.
        result = sortByNextAvailable(a, b, baseTime);
        if (shouldLog(a, b))
          console.log("Comparing next available:", result,
            "\n", a.name, getWindowStart(aRanges, 0).format(),
            "\n", b.name, getWindowStart(bRanges, 0).format());
        if (result != 0) {
          return result;
        }

        // How long is it up over the next n windows, relative to the other fish!
        aUptime = a.uptime();
        bUptime = b.uptime();
        // Compare uptime (shorter comes first)
        result = compare(aUptime, bUptime);
        if (shouldLog(a, b))
          console.log("Comparing uptime:", result,
            "\n", a.name, aUptime,
            "\n", b.name, bUptime);
        if (result != 0) return result;

        // If both are the same, the fish with the longer time till next window
        // comes first.
        result = compare(getWindowStart(bRanges, 1) || 0,
                         getWindowStart(aRanges, 1) || 0);
        if (shouldLog(a, b))
          console.log("Comparing time till next window:", result,
            "\n", a.name, getWindowStart(aRanges, 1).format(),
            "\n", b.name, getWindowStart(bRanges, 1).format());
        if (result == 0) {
          // Or, which ever fish's window closes first.
          result = compare(getWindowEnd(aRanges, 0),
                           getWindowEnd(bRanges, 0));
          if (shouldLog(a, b))
            console.log("Comparing remaining window time:", result,
              "\n", a.name, getWindowEnd(aRanges, 0).format(),
              "\n", b.name, getWindowEnd(bRanges, 0).format());
          if (result == 0) {
            // Ok fine... SORT BY ID!
            result = compare(a.id, b.id);
          }
        }

        return result;
      }

      class AppViewModel {
        constructor() {
          this.currentTick = ko.observable(0);
          Rx.Observable.interval(1000 /*ms*/).subscribe(
            (x) => this.currentTick(x)
          );

          this.eorzeaTime = ko.computed(() => {
            var __dummy = this.currentTick();
            return eorzeaTime.getCurrentEorzeaDate().format("HH:mm");
          });
          this.earthTime = ko.computed(() => {
            var __dummy = this.currentTick();
            return moment().format("dddd, MMMM Do YYYY, h:mm:ss a");
          });

          this.filterCompletion = ko.observable('all');
          this.filterPatch = ko.observableArray([
            2, 2.1, 2.2, 2.3, 2.4, 2.5,
            3, 3.1, 3.2, 3.3, 3.4, 3.5
          ]);

          this.fishes = ko.computed(() => {
            console.log("Recomputing displayed fish");
            var baseTime = eorzeaTime.getCurrentEorzeaDate();
            // Start with ALL the fishies.
            var fishes = Fishes;
            // Filter by patch.
            // var filterPatch = _(this.filterPatch()).map((v) => Number(v));
            fishes = _(fishes).filter(
              (f) => _(this.filterPatch()).contains(f.patch));
            // Sort the fish by rarity.
            fishes = fishes.sort((a, b) => sortByWindowPeriods(a, b, baseTime));

            return _(fishes).map((x) => {
              _(x).extend({
                catchabilityStatus: ko.computed(() => {
                  if (x.isCatchable()) {
                    return "blue";
                  } else {
                    return "";
                  }
                }),
                isCaught: ko.computed(() => false),
                availability: {
                  now: {
                    duration: ko.computed(() => {
                      var crs = x.catchableRanges();
                      if (crs.length > 0) {
                        if (moment().isBefore(eorzeaTime.toEarth(crs[0].start()))) {
                          return this.getUpdatedWindowTimer(eorzeaTime.toEarth(crs[0].start()));
                        } else {
                          return "closes " + this.getUpdatedWindowTimer(eorzeaTime.toEarth(crs[0].end()));
                        }
                      }
                      return "unknown";
                    }),
                    date: ko.computed(() => {
                      var crs = x.catchableRanges();
                      if (crs.length > 0) {
                        if (moment().isBefore(eorzeaTime.toEarth(crs[0].start()))) {
                          return eorzeaTime.toEarth(crs[0].start()).local().calendar();
                        } else {
                          return eorzeaTime.toEarth(crs[0].end()).local().calendar();
                        }
                      }
                    }),
                  },
                  next: {
                    duration: ko.computed(() => {
                      var crs = x.catchableRanges();
                      if (crs.length > 1) {
                        return this.getUpdatedWindowTimer(eorzeaTime.toEarth(crs[1].start()));
                      }
                      return "unknown";
                    }),
                    date: ko.computed(() => {
                      var crs = x.catchableRanges();
                      if (crs.length > 1) {
                        return eorzeaTime.toEarth(crs[1].start()).local().calendar();
                      }
                    }),
                  }
                }
              });
              return x;
            });
          }).extend({ deferred: true });
        }

        getUpdatedWindowTimer(date) {
          var __dummy = this.currentTick();
          return moment(date).fromNow();
        }
      }
      var viewModel = new AppViewModel();
    </script>

    <script type="text/javascript">
      $(() => {
        $filterCompletionButtons = $('#filterCompletion .button');
        $filterPatchButtons = $('#filterPatch .button');

        $filterCompletionButtons.on('click', function() {
          $(this).addClass('active').siblings().removeClass('active');
          viewModel.filterCompletion($(this).data('filter'));
        });

        $filterPatchButtons.on('click', function() {
          $(this).toggleClass('active');
          if ($(this).hasClass('active')) {
            viewModel.filterPatch.push($(this).data('filter'));
          } else {
            viewModel.filterPatch.remove($(this).data('filter'));
          }
          console.log("Patches:", viewModel.filterPatch());
        });
      })
    </script>

    <!-- <script type="text/javascript">
      $(() => {
        var mainTemplate = doT.template($('#main-template').text());
        $('body').html(mainTemplate());
      });
    </script> -->

    <script id="fish-template" type="text/html">
      <tr data-bind="css: catchabilityStatus">
        <td class="collapsed">
          <i data-bind="css: {'checkmark box icon': isCaught}"></i>
        </td>
        <td>
          <img data-bind="attr: { src: 'public/images/fish_n_tackle/' + icon }" style="float: left; margin-right: 1em;"/>
          <span data-bind="text: name"></span><br/>
          <div class="ui tiny circular label" data-bind="text: patch"></div>
        </td>
        <td>
          <!-- ko if: alwaysAvailable() === true -->
            Always
          <!-- /ko -->
          <div data-bind="if: alwaysAvailable() !== true">
            <span data-bind="attr: { 'data-tooltip': availability.now.date }, text: availability.now.duration"></span><br />
            <span style="font-size: smaller;">
              <b>Uptime:</b> <span data-bind="text: (uptime() * 100.0).toFixed(1)"></span>%
              <b>Next:</b> <span data-bind="attr: { 'data-tooltip': availability.next.date }, text: availability.next.duration"></span>
            </span>
          </div>
        </td>
        <td>
          <a data-bind="attr: { href: 'http://garlandtools.org/db/#fishing/' + location.id},
                        text: location.name" target="#top"></a><br/>
          <span style="font-size: smaller" data-bind="text: location.zoneName"></span>
        </td>
        <td data-bind="template: 'conditions-template'"></td>
        <td data-bind="template: 'bait-template'"></td>
      </tr>
    </script>

    <script id="conditions-template" type="text/html">
      <!-- ko with: conditions() -->
        <!-- ko foreach: previousWeatherSet -->
          <img class="weather-icon" data-bind="attr: { title: name, src: 'public/images/weather/' + icon }"/>
        <!-- /ko -->
        <span data-bind="if: previousWeatherSet.length > 0">
          <i class="arrow right icon"></i>
        </span>
        <!-- ko foreach: weatherSet -->
          <img class="weather-icon" data-bind="attr: { title: name, src: 'public/images/weather/' + icon }"/>
        <!-- /ko -->
        <br/><i class="wait icon"></i> <span data-bind="text: startHour + ' - ' + endHour"> </span>
      <!-- /ko -->
    </script>

    <script id="bait-template" type="text/html">
      <!-- ko with: bait() -->
        <!-- ko foreach: predators -->
          <!-- ko if: $index() > 0 -->
            <span style="width: 5px;">&nbsp;</span>
          <!-- /ko -->
          <span style="font-size: +150%; font-weight: bold;" data-bind="text: count"> </span>
          <img data-bind="attr: { title: name, src: 'public/images/fish_n_tackle/' + icon }"/>
        <!-- /ko -->
        <!-- ko if: hasPredators -->
          <i class="chevron right icon"></i>
        <!-- /ko -->
        <!-- ko if: $parent.fishEyes -->
          <img style="margin-left: 4px;" title="Fish Eyes" src="public/images/status/fisheyes.png"/>
        <!-- /ko -->
        <!-- ko if: $parent.snagging -->
          <img style="margin-left: 4px;" title="Snagging" src="public/images/status/snagging.png"/>
        <!-- /ko -->
        <!-- ko foreach: bestCatchPath -->
          <!-- ko if: $index() > 0 -->
            <i class="arrow right icon"></i>
            <img data-bind="attr: { title: name, src: 'public/images/fish_n_tackle/' + icon }"/>
          <!-- /ko -->
          <!-- ko if: $index() == 0 -->
            <a data-bind="attr: { href: 'http://www.garlandtools.org/db/#item/' + _id }"
               target="_top"><img data-bind="attr: { title: name, src: 'public/images/fish_n_tackle/' + icon }"/></a>
          <!-- /ko -->
        <!-- /ko -->
        <!-- ko if: $parent.hookset -->
          <img style="margin-left: 4px;"
               data-bind="attr: { title: $parent.hookset,
                                  src: 'public/images/action/' + $parent.hookset.toLowerCase() + '_hookset.png' }"/>
        <!-- /ko -->
      <!-- /ko -->
    </script>
  </head>
  <body>
    <!-- <div data-bind="template: 'main-template'"></div> -->

    <div class="ui text top fixed menu" style="background-color: white;">
      <div class="ui container">
        <div class="header item">FFX|V Fish Tracker App</div>
        <div class="right item">
          <b>Current Time:</b>&nbsp;
          <span data-bind="text: eorzeaTime"></span>&nbsp;
          (<span data-bind="text: earthTime"></span>)
        </div>
      </div>
    </div>
    <div class="ui main container">
      <h1>FFX|V Fish Tracker App</h1>
      <p>
        This application tracks big fish, making it easy to spot hard-to-catch fish as they become available - <a target="#top" href="http://na.finalfantasyxiv.com/lodestone/character/221572/">Carbuncle Plushy</a> of Balmung.
      </p>

      <div id="filterCompletion">
        <span class="ui">Completion:</span>
        <div class="ui mini buttons" style="margin-top: 4px;">
          <button class="ui active button" data-filter="all">All</button>
          <button class="ui button" data-filter="caught">Caught</button>
          <button class="ui button" data-filter="uncaught">Uncaught</button>
        </div>
      </div>
      <div id="filterPatch">
        <span class="ui">Patch:</span>
        <div class="ui mini buttons" style="margin-top: 4px;">
          <div class="ui active button" data-filter="2">2.0</div>
          <div class="ui active button" data-filter="2.1">2.1</div>
          <div class="ui active button" data-filter="2.2">2.2</div>
          <div class="ui active button" data-filter="2.3">2.3</div>
          <div class="ui active button" data-filter="2.4">2.4</div>
          <div class="ui active button" data-filter="2.5">2.5</div>
        </div>
        <div class="ui mini buttons">
          <div class="ui active button" data-filter="3">3.0</div>
          <div class="ui active button" data-filter="3.1">3.1</div>
          <div class="ui active button" data-filter="3.2">3.2</div>
          <div class="ui active button" data-filter="3.3">3.3</div>
          <div class="ui active button" data-filter="3.4">3.4</div>
          <div class="ui active button" data-filter="3.5">3.5</div>
        </div>
      </div>

      <!-- Display the list of fish -->
      <table id="fishes" class="ui selectable striped very basic very compact table">
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Availability</th>
            <th>Location</th>
            <th>Conditions</th>
            <th>Bait</th>
          </tr>
        </thead>
        <tbody data-bind="template: { name: 'fish-template',
                                      foreach: fishes }"></tbody>
      </table>
    </div>

    <script type="text/javascript">
      ko.applyBindings(viewModel);
      //fishWatcher.updateFishes();
    </script>
  </body>
</html>
